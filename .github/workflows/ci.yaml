name: Renovate - CI

on:
  push:
    branches: 
      - '*'
      - '!main'   # excludes main

  pull_request:
    branches:  
      - '*'


# permissions:
#   checks: write
#   contents: read
#   pull-requests: write

permissions:
  contents: read
  packages: write  # Required for pushing to GHCR

jobs:
  build-test:
    name: "Build ci.yaml"  
    runs-on: ubuntu-latest
    environment: staging  # Assigns staging environment
    env:
      GIT_COMMIT_MSG: '${{ github.event.head_commit.message }}'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Generate DevContainer image tag
      id: devcontainer-tag
      run: |
        # Use the same logic as build-devcontainer.yaml to generate the tag
        BRANCH_NAME="${{ github.ref_name }}"
        CLEAN_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g')
        
        # Use base image name without tag - let devcontainers/ci handle tagging
        DEVCONTAINER_IMAGE="ghcr.io/${{ github.repository }}/devcontainer"
        
        echo "image=${DEVCONTAINER_IMAGE}" >> $GITHUB_OUTPUT
        echo "Using DevContainer image: ${DEVCONTAINER_IMAGE}"

    - name: Check Tool Versions in DevContainer
      uses: devcontainers/ci@v0.3
      with:
        imageName: ${{ steps.devcontainer-tag.outputs.image }}
        cacheFrom: ghcr.io/${{ github.repository }}/devcontainer:latest
        configFile: .devcontainer/21_renovate_amd64/devcontainer.json
        runCmd: |
          echo "=== Tool Versions ==="
          node --version
          just --version
          TEST_OUTPUT_FOLDER=$(pwd)/out/tests/junit
          mkdir -p ${TEST_OUTPUT_FOLDER}          

    - name: Build in DevContainer
      uses: devcontainers/ci@v0.3
      with:
        imageName: ${{ steps.devcontainer-tag.outputs.image }}
        cacheFrom: ghcr.io/${{ github.repository }}/devcontainer:latest
        configFile: .devcontainer/21_renovate_amd64/devcontainer.json
        runCmd: |
          echo "=== Building ==="
          just build

    - name: Test in DevContainer
      uses: devcontainers/ci@v0.3
      with:
        imageName: ${{ steps.devcontainer-tag.outputs.image }}
        cacheFrom: ghcr.io/${{ github.repository }}/devcontainer:latest
        configFile: .devcontainer/21_renovate_amd64/devcontainer.json
        runCmd: |
          echo "=== Testing ==="
          just test